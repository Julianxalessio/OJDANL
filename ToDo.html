<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meine ToDo Liste</title>
    <link rel="stylesheet" href="NavBar.css">
    <style>
        body {
            font-family: sans-serif;
            padding: 40px;
        }

        form {
            margin-bottom: 30px;
        }

        input[type="text"] {
            padding: 8px;
            font-size: 16px;
            width: 250px;
        }

        button {
            padding: 8px 12px;
            font-size: 16px;
        }

        li {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .erledigt {
            text-decoration: line-through;
            color: gray;
        }
    </style>
</head>

<body>
    <div class="NavBar">
        <a href="index.html">Home</a>
        <a class="active" href="ToDo.html">ToDo</a>
        <a href="Ereignisse.html">Timeline</a>
        <a href="Geplant.html">Geplant</a>
        <a href="WichtigeDaten.html">Wichtige Daten</a>
    </div>

    <h2>üìù Meine ToDo Liste</h2>

    <form id="todoForm">
        <input type="text" id="aufgabe" placeholder="Neue Aufgabe..." required>
        <button type="submit">Hinzuf√ºgen</button>
    </form>

    <ul id="todoListe" style="list-style: none; padding: 0;"></ul>

    <script>
        const repo = "Julianxalessio/OJDANL";
        const filePath = "ToDo.json";
        const token = "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"; // Nur privat verwenden!
        const branch = "main";

        function toBase64Unicode(str) {
            return window.btoa(
                new TextEncoder().encode(str).reduce((data, byte) => data + String.fromCharCode(byte), "")
            );
        }

        document.getElementById('todoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const aufgabe = document.getElementById('aufgabe').value.trim();
            if (!aufgabe) return;

            try {
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
                    headers: { 'Authorization': `token ${token}` }
                });

                const fileData = await res.json();
                const decoded = fileData.content ? atob(fileData.content) : "[]";
                const json = JSON.parse(decoded);

                json.push({
                    id: Date.now(),
                    aufgabe,
                    erledigt: false
                });

                const updatedContent = toBase64Unicode(JSON.stringify(json, null, 2));

                await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
                    method: "PUT",
                    headers: {
                        "Authorization": `token ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        message: `Neue Aufgabe hinzugef√ºgt`,
                        content: updatedContent,
                        sha: fileData.sha,
                        branch: branch
                    })
                });

                document.getElementById('todoForm').reset();
                ladeListe();

            } catch (error) {
                console.error("Fehler beim Hinzuf√ºgen:", error);
            }
        });

        async function ladeListe() {
            try {
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
                    headers: { 'Authorization': `token ${token}` }
                });

                const fileData = await res.json();
                const decoded = fileData.content ? atob(fileData.content) : "[]";
                const json = JSON.parse(decoded);

                const liste = document.getElementById('todoListe');
                liste.innerHTML = "";

                json.forEach(item => {
                    const li = document.createElement('li');

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = item.erledigt || false;
                    checkbox.addEventListener('change', () => {
                        const index = json.findIndex(e => e.id === item.id);
                        json[index].erledigt = checkbox.checked;
                        speichereListe(json);
                    });

                    const text = document.createElement('span');
                    text.textContent = item.aufgabe;
                    if (item.erledigt) text.classList.add("erledigt");

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = "üóëÔ∏è";
                    deleteBtn.addEventListener('click', () => {
                        const neueListe = json.filter(e => e.id !== item.id);
                        speichereListe(neueListe);
                    });

                    li.appendChild(checkbox);
                    li.appendChild(text);
                    li.appendChild(deleteBtn);
                    liste.appendChild(li);
                });

            } catch (error) {
                console.error("Fehler beim Laden:", error);
            }
        }

        async function speichereListe(neueDaten) {
    try {
        const res = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
            headers: { 'Authorization': `token ${token}` }
        });

        if (!res.ok) throw new Error("Konnte Datei nicht abrufen");

        const fileData = await res.json();

        const updatedContent = toBase64Unicode(JSON.stringify(neueDaten, null, 2));

        const putRes = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
            method: "PUT",
            headers: {
                "Authorization": `token ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                message: `ToDo-Liste aktualisiert`,
                content: updatedContent,
                sha: fileData.sha,
                branch: branch
            })
        });

        if (!putRes.ok) {
            const err = await putRes.json();
            throw new Error(err.message);
        }

        ladeListe();

    } catch (error) {
        console.error("‚ùå Fehler beim Speichern/L√∂schen:", error.message || error);
        alert("‚ùå Fehler beim Speichern/L√∂schen:\n" + (error.message || error));
    }
}


        // Beim Laden der Seite die Liste anzeigen
        ladeListe();
    </script>

</body>

</html>
